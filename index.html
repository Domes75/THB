<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Incidencias - Hotel</title>
    <link rel="stylesheet" href="css-code.css">
    <!-- CSS para forzar la visibilidad correcta -->
    <style>
      #loginForm {
        display: block !important;
        visibility: visible !important;
      }

      #contenido {
        display: none !important;
      }
    </style>
    <!-- LibrerÃ­a Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>
  <body>
    <h1>Gestor de Incidencias</h1>
    <!-- Formulario de login -->
    <div id="loginForm">
      <input type="email" id="email" placeholder="Correo" autocomplete="email">
      <input type="password" id="password" placeholder="ContraseÃ±a" autocomplete="current-password">
      <button onclick="login()">Entrar</button>
    </div>
    <div id="contenido" style="display:none">
      <p>Â¡Bienvenido! AquÃ­ estarÃ¡ el contenido protegido.</p>
    </div>
    <!-- Todo el JS al final del body -->
    <script>
      // Forzar estado inicial correcto
      document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('loginForm').style.display = 'block';
        document.getElementById('contenido').style.display = 'none';
      });
      // Crear cliente Supabase
      const {
        createClient
      } = supabase;
      const supabaseUrl = 'https://elbzrevmughchxxytngd.supabase.co';
      const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVsYnpyZXZtdWdoY2h4eHl0bmdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0MzM5NTksImV4cCI6MjA3MTAwOTk1OX0.1JY9gKQ93V0uu8DNKx9rOlcNwwzyfq4GsNuvayipCeM';
      const supabaseClient = createClient(supabaseUrl, supabaseKey);
      // Detectar cambios de sesiÃ³n
      supabaseClient.auth.onAuthStateChange((event, session) => {
        console.log("Estado:", event, session);
        if (session) {
          document.getElementById('contenido').style.display = 'block';
          document.getElementById('loginForm').style.display = 'none';
          document.body.classList.add('authenticated');

    
          
        } else {
          document.getElementById('contenido').style.display = 'none';
          document.getElementById('loginForm').style.display = 'block';
          document.body.classList.remove('authenticated');
        }
        
        // SuscripciÃ³n a Realtime (poner aquÃ­)
if (typeof supabaseClient !== 'undefined') {
    const incidenciasChannel = supabaseClient
        .channel('public:incidencias')
        .on(
            'postgres_changes',
            { event: '*', schema: 'public', table: 'incidencias' },
            (payload) => {
                console.log('ğŸ”„ Cambio detectado en Supabase:', payload);
                cargarIncidenciasSupabase(); // refresca la lista
            }
        )
        .subscribe();

    console.log('ğŸ“¡ SuscripciÃ³n a Realtime creada:', incidenciasChannel);
}

      });
      // FunciÃ³n de login
      async function login() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        console.log("Intentando login con:", email); // Para debug
        const {
          data,
          error
        } = await supabaseClient.auth.signInWithPassword({
          email: email,
          password: password
        });
        if (error) {
          console.error("Error:", error);
          alert("Error: " + error.message);
        } else {
          console.log("Login correcto", data);
        }
      }
    </script>
  </body>
</html>
<!-- Tu CSS -->
<link rel="stylesheet" href="css-code.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
</head>
<body>
  <div id="alertsContainer" class="alerts-container"></div>
  <div class="modern-header">
    <div class="header-content">
      <div class="header-left">
        <div class="header-icon">ğŸ¨</div>
        <div class="header-title">
          <h1>Sistema de gestiÃ³n de incidencias en las habitaciones</h1>
          <p>THB Flora: 200 habitaciones</p>
        </div>
      </div>
    </div>
  </div>
  <div class="stats-section">
    <div class="stats-container">
      <div class="stat-card" onclick="filterByAll()">
        <div class="stat-icon">ğŸ¨</div>
        <div class="stat-content">
          <div class="stat-label">Habitaciones Totales</div>
          <div class="stat-number">200</div>
        </div>
      </div>
      <div class="stat-card" onclick="filterByStatus('libre')">
        <div class="stat-icon">âœ…</div>
        <div class="stat-content">
          <div class="stat-label">Disponibles</div>
          <div class="stat-number" id="libres">0</div>
        </div>
      </div>
      <div class="stat-card" onclick="filterByIncidents('total-incidents')">
        <div class="stat-icon">âš ï¸</div>
        <div class="stat-content">
          <div class="stat-label">Con Incidencias</div>
          <div class="stat-number" id="total-incidents">0</div>
        </div>
      </div>
      <div class="stat-card critical" onclick="filterByStatus('critica')">
        <div class="stat-icon">ğŸš¨</div>
        <div class="stat-content">
          <div class="stat-label">CrÃ­ticas</div>
          <div class="stat-number" id="criticas">0</div>
        </div>
      </div>
      <div class="stat-card" onclick="filterByStatus('bloqueada')">
        <div class="stat-icon">ğŸ”’</div>
        <div class="stat-content">
          <div class="stat-label">Bloqueadas</div>
          <div class="stat-number" id="bloqueadas">0</div>
        </div>
      </div>
      <div class="stat-card alert" onclick="filterByAlerts('alertasActivas')">
        <div class="stat-icon">ğŸ””</div>
        <div class="stat-content">
          <div class="stat-label">Alertas Activas</div>
          <div class="stat-number" id="alertasActivas">0</div>
        </div>
      </div>
      <div class="stat-card" onclick="filterByExpired('caducadas')">
        <div class="stat-icon">â°</div>
        <div class="stat-content">
          <div class="stat-label">Incidencias Caducadas</div>
          <div class="stat-number" id="caducadas">0</div>
        </div>
      </div>
    </div>
  </div>
  <div class="controls">
    <input type="text" id="searchRoom" class="search-input" placeholder="ğŸ” Buscar habitaciÃ³n...">
    <select id="filterStatus" class="filter-select">
      <option value="">Todos los estados</option>
      <option value="libre">Solo libres</option>
      <option value="bloqueada">Solo bloqueadas</option>
      <option value="leve">Incidencias leves</option>
      <option value="moderada">Incidencias moderadas</option>
      <option value="grave">Incidencias graves</option>
      <option value="critica">Incidencias crÃ­ticas</option>
    </select>
    <select id="filterType" class="filter-select">
      <option value="">Todas las tipologÃ­as</option>
      <option value="electrico">ElÃ©ctrico</option>
      <option value="fontaneria">FontanerÃ­a</option>
      <option value="limpieza">Limpieza</option>
      <option value="climatizacion">ClimatizaciÃ³n</option>
      <option value="otro">Otro</option>
    </select>
    <input type="text" id="filterTag" class="search-input" placeholder="ğŸ·ï¸ Filtrar por etiqueta...">
    <button class="control-btn export-btn" onclick="exportData()"> ğŸ“Š Exportar </button>
    <button class="control-btn history-btn" onclick="openHistoryModal()"> ğŸ“‹ Historial <span id="historyIndicator" class="history-indicator" style="display: none;"></span>
    </button>
    <button class="control-btn alert-btn" onclick="checkAlerts()"> ğŸ”” Alertas </button>
    <button class="control-btn clear-btn" onclick="clearAllData()"> ğŸ—‘ï¸ Borrar datos </button>
  </div>
  <div class="main-container">
    <div class="content-area">
      <div class="rooms-grid" id="roomsGrid"></div>
    </div>
    <div class="agenda-panel">
      <div class="agenda-header">
        <h3>ğŸ“… Calendario</h3>
        <div class="agenda-nav">
          <button onclick="previousMonth()">&lt;&lt;</button>
          <span id="currentMonth" style="margin: 0 12px; font-weight: 400;"></span>
          <button onclick="nextMonth()">&gt;&gt;</button>
        </div>
      </div>
      <!-- Calendario Mensual -->
      <div id="calendarGrid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #e5e7eb; margin: 8px; border-radius: 6px; overflow: hidden;">
        <!-- Se genera dinÃ¡micamente -->
      </div>
      <!-- Detalles del dÃ­a seleccionado -->
      <div style="padding: 12px; border-top: 1px solid #e5e7eb;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <h4 id="selectedDate" style="margin: 0; color: #1e293b;">Selecciona un dÃ­a</h4>
          <button onclick="showEventModal()" style="background: #3b82f6; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px;"> + Evento </button>
        </div>
        <div id="dayEvents" style="max-height: 300px; overflow-y: auto;">
          <!-- Eventos del dÃ­a -->
        </div>
        <!-- Lista global de eventos -->
        <div style="padding: 12px; border-top: 1px solid #e5e7eb;">
          <h4 style="margin-bottom: 8px; color: #1e293b;">ğŸ“‹ Lista de todos los eventos</h4>
          <div id="eventList" style="max-height: 300px; overflow-y: auto;">
            <!-- AquÃ­ se pintarÃ¡n todos los eventos -->
          </div>
        </div>
      </div>
    </div>
    <!-- Fondo oscuro del modal -->
    <div id="eventModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 3999;">
      <div style="background: white; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); 
                width: 300px; padding: 16px; position: absolute; top: 50%; left: 50%; 
                transform: translate(-50%, -50%);">
        <h5 style="margin: 0 0 12px 0;">Nuevo Evento</h5>
        <select id="eventType" style="width: 100%; padding: 6px; margin-bottom: 8px; border: 1px solid #ccc; border-radius: 4px;">
          <option value="nota">ğŸ“ Nota</option>
          <option value="mantenimiento">ğŸ”§ Mantenimiento</option>
          <option value="reserva">ğŸ¨ Reserva</option>
          <option value="alerta">âš ï¸ Alerta</option>
        </select>
        <input type="text" id="eventTitle" placeholder="TÃ­tulo del evento..." style="width: 100%; padding: 6px; margin-bottom: 8px; border: 1px solid #ccc; border-radius: 4px;">
        <textarea id="eventDescription" placeholder="DescripciÃ³n..." style="width: 100%; padding: 6px; margin-bottom: 8px; border: 1px solid #ccc; border-radius: 4px; height: 60px;"></textarea>
        <input type="time" id="eventTime" style="width: 100%; padding: 6px; margin-bottom: 12px; border: 1px solid #ccc; border-radius: 4px;">
        <div style="display: flex; gap: 8px;">
          <button onclick="addCalendarEvent()" style="flex: 1; background: #22c55e; color: white; border: none; padding: 8px; border-radius: 4px;"> Guardar </button>
          <button onclick="closeEventModal()" style="flex: 1; background: #6b7280; color: white; border: none; padding: 8px; border-radius: 4px;"> Cancelar </button>
        </div>
      </div>
    </div>
    <!-- Context Menu -->
    <div id="contextMenu" class="context-menu" style="display: none; position: fixed; background: white; border: 1px solid #e5e7eb; border-radius: 6px; padding: 4px 0; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); z-index: 2000; font-size: 13px;">
      <div class="context-menu-item" onclick="markAsOccupied()" style="padding: 8px 12px; cursor: pointer; transition: background 0.2s;">ğŸ  Marcar como ocupada</div>
      <div class="context-menu-item" onclick="markAsBlocked()" style="padding: 8px 12px; cursor: pointer; transition: background 0.2s;">ğŸ”’ Marcar como bloqueada</div>
      <div class="context-menu-item" onclick="markAsFree()" style="padding: 8px 12px; cursor: pointer; transition: background 0.2s;">âœ… Marcar como libre</div>
    </div>
    <!-- Modal Principal -->
    <div id="roomModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modalTitle">HabitaciÃ³n 101</h2>
          <button class="close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
          <div class="modal-tabs">
            <button class="modal-tab active" onclick="showTab('incidents')">ğŸ“‹ Incidencias</button>
            <button class="modal-tab" onclick="showTab('guest')">ğŸ‘¤ HuÃ©sped</button>
            <button class="modal-tab" onclick="showTab('room-notes')">ğŸ“ Notas</button>
            <button class="modal-tab" onclick="showTab('history')">ğŸ“š Historial</button>
          </div>
          <!-- PestaÃ±a de Incidencias -->
          <div id="incidentsTab" class="tab-content active">
            <div id="managementAlert" class="management-alert" style="display: none;">
              <div>âš ï¸</div>
              <div class="management-alert-content">
                <strong>AtenciÃ³n DirecciÃ³n:</strong> Esta incidencia requiere notificaciÃ³n inmediata a DirecciÃ³n.
              </div>
              <button onclick="notifyManagement()">Notificar</button>
            </div>
            <div class="form-grid form-grid-3">
              <div class="form-group">
                <label for="incidentSeverity">Gravedad:</label>
                <select id="incidentSeverity" onchange="checkManagementNotification()">
                  <option value="leve">Leve</option>
                  <option value="moderada">Moderada</option>
                  <option value="grave">Grave</option>
                  <option value="critica">CrÃ­tica</option>
                </select>
              </div>
              <div class="form-group">
                <label for="incidentType">TipologÃ­a:</label>
                <select id="incidentType" onchange="updatePopularTags()">
                  <option value="electrico">âš¡ ElÃ©ctrico</option>
                  <option value="fontaneria">ğŸ’§ FontanerÃ­a</option>
                  <option value="limpieza">ğŸ§½ Limpieza</option>
                  <option value="climatizacion">â„ï¸ ClimatizaciÃ³n</option>
                  <option value="otro">ğŸ”§ Otro</option>
                </select>
              </div>
              <div class="form-group">
                <label for="incidentPriority">Prioridad:</label>
                <select id="incidentPriority">
                  <option value="baja">Baja</option>
                  <option value="normal">Normal</option>
                  <option value="alta">Alta</option>
                  <option value="urgente">Urgente</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label for="incidentDescription">DescripciÃ³n detallada:</label>
              <textarea id="incidentDescription" placeholder="Describe la incidencia en detalle..."></textarea>
            </div>
            <div class="form-group">
              <label for="incidentTag">Etiqueta/Tag:</label>
              <div class="tag-input-container">
                <input type="text" id="incidentTag" placeholder="Ej: aire acondicionado, toallas...">
              </div>
              <div class="popular-tags" id="popularTags"></div>
            </div>
            <div class="form-grid form-grid-2">
              <div class="form-group">
                <label for="reportedBy">Reportado por:</label>
                <input type="text" id="reportedBy" placeholder="Nombre del empleado">
              </div>
              <div class="form-group">
                <label for="expiryDate">Fecha lÃ­mite:</label>
                <input type="date" id="expiryDate">
              </div>
            </div>
            <div class="form-grid form-grid-2">
              <div class="form-group">
                <label for="alertDate">Alerta - Fecha:</label>
                <input type="date" id="alertDate">
              </div>
              <div class="form-group">
                <label for="alertTime">Alerta - Hora:</label>
                <input type="time" id="alertTime">
              </div>
            </div>
            <div class="form-group">
              <label for="alertMessage">Mensaje de recordatorio:</label>
              <input type="text" id="alertMessage" placeholder="Ej: Recordar llamar al tÃ©cnico a las 14:00">
            </div>
            <div style="margin: 16px 0;">
              <button class="btn btn-primary" onclick="addIncident()">â• Agregar incidencia</button>
              <button class="btn btn-warning" onclick="resolveAllIncidents()">âœ… Resolver todas</button>
              <button class="btn btn-danger" onclick="clearAllIncidents()">ğŸ—‘ï¸ Eliminar todas</button>
            </div>
            <div class="incidents-list" id="incidentsList"></div>
          </div>
          <!-- PestaÃ±a de HuÃ©sped -->
          <div id="guestTab" class="tab-content">
            <div class="form-grid form-grid-2">
              <div class="form-group">
                <label for="guestName">Nombre:</label>
                <input type="text" id="guestName" placeholder="Nombre del huÃ©sped">
              </div>
              <div class="form-group">
                <label for="guestSurname">Apellidos:</label>
                <input type="text" id="guestSurname" placeholder="Apellidos del huÃ©sped">
              </div>
            </div>
            <div class="form-grid form-grid-3">
              <div class="form-group">
                <label for="guestPax">NÃºmero de PAX:</label>
                <input type="number" id="guestPax" placeholder="1" min="1">
              </div>
              <div class="form-group">
                <label for="guestPhone">TelÃ©fono:</label>
                <input type="tel" id="guestPhone" placeholder="+34 123 456 789">
              </div>
              <div class="form-group">
                <label for="guestAgency">Agencia:</label>
                <input type="text" id="guestAgency" placeholder="Agencia/Tour Operator">
              </div>
            </div>
            <div class="form-grid form-grid-2">
              <div class="form-group">
                <label for="checkInDate">Fecha de entrada:</label>
                <input type="date" id="checkInDate">
              </div>
              <div class="form-group">
                <label for="checkOutDate">Fecha de salida:</label>
                <input type="date" id="checkOutDate">
              </div>
            </div>
            <div style="margin: 16px 0;">
              <button class="btn btn-success" onclick="saveGuestInfo()">ğŸ’¾ Guardar informaciÃ³n</button>
              <button class="btn btn-secondary" onclick="clearGuestInfo()">ğŸ§¹ Limpiar datos</button>
            </div>
          </div>
          <!-- PestaÃ±a de Notas de HabitaciÃ³n -->
          <div id="roomNotesTab" class="tab-content">
            <div class="form-group">
              <label for="roomDescription">DescripciÃ³n de la habitaciÃ³n:</label>
              <textarea id="roomDescription" placeholder="Ej: Tiene terraza grande con vistas al mar, sol por la maÃ±ana hasta las 12h, wifi potente..." style="min-height: 100px;"></textarea>
            </div>
            <div class="form-group">
              <label for="roomFeatures">CaracterÃ­sticas especiales:</label>
              <input type="text" id="roomFeatures" placeholder="Ej: terraza, vistas mar, wifi premium, minibar...">
            </div>
            <div class="form-group">
              <label for="roomNotes">Notas importantes:</label>
              <textarea id="roomNotes" placeholder="InformaciÃ³n adicional relevante para el personal..." style="min-height: 80px;"></textarea>
            </div>
            <div style="margin: 16px 0;">
              <button class="btn btn-success" onclick="saveRoomNotes()">ğŸ’¾ Guardar notas</button>
              <button class="btn btn-secondary" onclick="clearRoomNotes()">ğŸ§¹ Limpiar notas</button>
            </div>
          </div>
          <!-- PestaÃ±a de Historial -->
          <div id="historyTab" class="tab-content">
            <div id="roomHistoryList">
              <p style="text-align: center; color: #6b7280; padding: 20px;">No hay incidencias resueltas</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Modal de Historial General -->
    <div id="historyModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>ğŸ“š Historial General de Incidencias</h2>
          <button class="close" onclick="closeHistoryModal()">&times;</button>
        </div>
        <div class="modal-body">
          <div class="controls" style="padding: 10px 0; border: none;">
            <input type="text" id="historySearch" class="search-input" placeholder="ğŸ” Buscar en historial..." oninput="filterHistory()">
            <select id="historyFilterType" class="filter-select" onchange="filterHistory()">
              <option value="">Todas las tipologÃ­as</option>
              <option value="electrico">ElÃ©ctrico</option>
              <option value="fontaneria">FontanerÃ­a</option>
              <option value="limpieza">Limpieza</option>
              <option value="climatizacion">ClimatizaciÃ³n</option>
              <option value="otro">Otro</option>
            </select>
            <select id="historyFilterSeverity" class="filter-select" onchange="filterHistory()">
              <option value="">Todas las gravedades</option>
              <option value="leve">Leve</option>
              <option value="moderada">Moderada</option>
              <option value="grave">Grave</option>
              <option value="critica">CrÃ­tica</option>
            </select>
            <button class="btn btn-secondary" onclick="exportHistoryData()">ğŸ“Š Exportar historial</button>
          </div>
          <div id="generalHistoryList"></div>
        </div>
      </div>
    </div>
    <script src="javascript-code.js"></script>
</body>
</html>
